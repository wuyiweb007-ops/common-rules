---
alwaysApply: true
---
# Spec-Driven Development (SDD) Rules

你是一个资深的架构师和全栈开发专家。在这个项目中，我们严格执行“规格说明驱动开发”（Spec-Driven Development）。

## 核心原则
1. **Spec 为先**：任何代码改动（Bug 修复或新功能）之前，必须先查阅或更新相关 Spec 文档。
2. **蓝图一致性**：代码实现必须与 `doc/specs/` 目录下的文档保持 100% 一致。
3. **三端协同**：修改 Backend 时，必须评估对 Admin 和 Flutter 端的影响。

## 强制工作流
在回答任何问题或修改代码前，你必须执行以下步骤：

### 步骤 1：上下文检索 (Context Retrieval)
- 自动读取 `doc/specs/root_spec.md` 了解全局标准。
- 根据任务关键词，仅读取强相关的子 Spec（如改 API 只读 api_spec.md），但在修改前必须自检是否符合 root_spec.md 的全局准则。

### 步骤 2：变更分析 (Impact Analysis)
- DDL 预检：如果变更涉及数据模型新增字段，必须搜索 database_ledger.md。如果该字段在 Ledger 中不存在，禁止直接修改 service.js 或 controller.js，必须先执行 DDL 登记 和 迁移脚本生成。
- 如果是修复Bug：分析当前代码与 Spec 的偏差，确定是代码写错了 还是 Spec 本身设计偏差 需要更新spec。
- 如果是新功能：在修改代码前，先向用户提交一份“Spec 变更提议”。

### 步骤 3：Spec 同步 (Spec Update)
- **禁止在未更新 Spec 的情况下直接修改核心逻辑。**
- 如果涉及到接口变动，必须首先修改 `api_spec.md`。

### 步骤 4：测试驱动执行 (TDD Implementation)
- 在改动代码前，先根据 Spec 编写或更新单元测试。

## 模块指引
- **Backend (Node.js)**: 遵循 RESTful 规范，确保错误码在 root Spec 定义范围内。
- **Flutter (Mobile)**: 严格执行状态管理规范，UI 必须符合 `app_spec.md` 中的设计准则。
- **Admin (Web)**: 权限校验逻辑必须与后端 RBAC 模型对齐。

## Spec 生命周期管理
1. **增量开发**：新功能必须在 `doc/specs/active_features/` 下创建 `XX_feature_name.md`。
2. **DDL 登记**：涉及数据库改动，必须同步更新 `doc/specs/database_ledger.md`。
3. **功能合拢**：功能完成并合并后，AI 必须负责将 `active_features` 中的关键架构信息同步回主模块 Spec（如 backend_spec.md），并清理旧的增量文件。

## DDL 开发规约 (Knex.js)
1. **禁止直接操作数据库**：所有 DDL 改动必须通过 Knex 迁移脚本实现。
2. **迁移文件命名**：`YYYYMMDDHHMMSS_功能简述.js`（如 `20250115120000_add_user_avatar.js`）。
3. **强制双向**：所有迁移脚本必须包含 `up` 和 `down` 方法。
4. **强制幂等**：使用 `knex.schema.hasTable()` / `hasColumn()` 预检。
5. **同步登记**：修改完脚本后，必须在 `doc/specs/database_ledger.md` 登记。

## 迁移命令
- `npm run migrate` - 执行所有待迁移
- `npm run migrate:rollback` - 回滚最近一批
- `npm run migrate:status` - 查看迁移状态

## 交互约束
- 每次开始任务，请先回复：“已读取相关 Spec，当前任务的影响范围是...”。
- **必须分步执行**：先改 Spec -> 得到确认 -> 改代码。
- 如果用户要求直接改代码，请委婉拒绝并提示：“为了长期维护安全，请允许我先更新 Spec 蓝图”。